{% extends 'base2.html.twig' %}

{% block title %}User index{% endblock %}

{% block body %}
    <h1>User :</h1>
 <div class="filter-option-box w-20">
<form>
                            <input type="text" id="search-input" placeholder="Rechercher..." class="form-control form--control">
                        </form>
                        <!-- Zone d'affichage des résultats -->
                        <div id="search-results"></div>
  
                        <script>
                            // Écouter les événements de saisie de texte dans le champ de recherche
                            const searchInput = document.getElementById('search-input');
                            searchInput.addEventListener('input', function () {
  
                                // Récupérer le contenu du champ de recherche
                                const keyword = searchInput.value.trim();
  
                                // Effectuer la requête AJAX si le contenu est non vide
                                if (keyword) {
                                    const xhr = new XMLHttpRequest();
                                    xhr.onreadystatechange = function () {
                                        if (xhr.readyState === 4 && xhr.status === 200) {
                                            // Traitement des données de réponse ici
                                            const response = JSON.parse(xhr.responseText);
                                            const resultsContainer = document.getElementById('search-results');
                                            const listeRend = document.querySelector('#users-table');
                                            resultsContainer.innerHTML = '';
                                            if (response.data.length > 0) {
                                                let dataHtml = "";
  
                                                response.data.forEach(function (result) {
                                                    /*
                                                    liste-consultation
                                                    */
  
                                                    const element = `
        
                                                    <tr>
                                   
                                    
                                                      <td>
                                                            <font style="vertical-align: inherit;">
                                                                <font style="vertical-align: inherit;">
                                                                    ${result.email}
                                                                </font>
                                                            </font>
                                                        </td>
                                                        <td>
                                                            <font style="vertical-align: inherit;">
                                                                <font style="vertical-align: inherit;">
                                                                    ${result.id}
                                                                </font>
                                                            </font>
                                                        </td>
                                                        <td></td>
                                   
                                   `;
                                                    console.log(result);
                                                    dataHtml += element;
                                                    /* const resultElement = document.createElement('div');
                                                    resultElement.textContent = result.date;
                                                    resultsContainer.appendChild(resultElement);*/
                                                });
                                                listeRend.innerHTML = dataHtml;
                                            } else {
                                                const noResultsElement = document.createElement('div');
                                                noResultsElement.textContent = 'Aucun résultat trouvé.';
                                                resultsContainer.appendChild(noResultsElement);
                                            }
                                        }
                                    };
                                    xhr.open('GET',"{{path('search_users')}}?keyword=" + keyword  );
  xhr.send();
  }
  });
  </script>
     </div>

    <table id="users-table" class="table " style="background-color:white;">
        <thead>
            <tr>
                <th>Id</th>
                <th>Email</th>
                
              
                <th>IsVerified</th>
                <th>actions</th>
            </tr>
        </thead>
        <tbody>
        {% for user in users %}
            <tr>
                <td>{{ user.id }}</td>
                <td>{{ user.email }}</td>
           
               
                <td>{{ user.isVerified ? 'Yes' : 'No' }}</td>
                <td>
                    <a href="{{ path('app_admin_user_show', {'id': user.id}) }}">show</a>
                    <a href="{{ path('app_admin_user_edit', {'id': user.id}) }}">edit</a>
                    <a href="{{path('Status',{'id':user.id})}}">{{user.getStatus}}</a>
                </td>
            </tr>
        {% else %}
            <tr>
                <td colspan="6">no records found</td>
            </tr>
        {% endfor %}
        </tbody>
        
    </table>
     {{ knp_pagination_render(users) }}
<button id="download-btn" type="button">Download CSV</button>

</table>

<style>
  #download-btn {
    display: inline-block;
    padding: 0.5em 1em;
    font-size: 1em;
    font-weight: bold;
    text-decoration: none;
    color: #fff;
    background-color: #007bff;
    border: 1px solid #007bff;
    border-radius: 0.25em;
    cursor: pointer;
  }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script>
  // Add a click event listener to the download button
  document.getElementById('download-btn').addEventListener('click', function() {
    // Generate a comma-separated values (CSV) string from the table data
    var csvString = 'ID;EMAIL;Is Verified\n';
    var rows = document.querySelectorAll('#users-table tbody tr');
    // Parcours table
    for (var i = 0; i < rows.length; i++) {
      var cells = rows[i].querySelectorAll('td');
      for (var j = 0; j < cells.length-1; j++) {
        csvString += '"' + cells[j].textContent.trim().replace(/"/g, '""') + '";';
      }
      csvString += '\n';
    }

    // Download the CSV file
    var link = document.createElement('a');
    link.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvString));
    link.setAttribute('download', 'users.csv');
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  });
</script>
    <a href="{{ path('app_admin_user_new') }}">Create new</a>
{% endblock %}
